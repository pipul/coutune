<?php// 文件说明：用户管理if(!defined('TXP_ROOT') || !isset($php_self) || !preg_match("/[\/\\\\]admincp\.php$/", $php_self)) {	exit('Access Denied');}// 权限检查permission();if (!$action) {    $action = 'list';}$groupdb = array(	'1' => '管理组',	'2' => '撰写组',);// 添加用户if($action == 'adduser') {	$username       = trim($_POST['username']);	$newpassword    = trim($_POST['newpassword']);	$comfirpassword = trim($_POST['comfirpassword']);	$url            = trim($_POST['url']);	$groupid        = intval($_POST['groupid']);	if (!$username || strlen($username) > 20) {		redirect('登陆名不能为空并且不能超过20个字符');    }	$name_key = array("\\",'&',' ',"'",'"','/','*',',','<','>',"\r","\t","\n",'#','$','(',')','%','@','+','?',';','^');	foreach($name_key as $value){		if (strpos($username,$value) !== false){			redirect('用户名包含敏感字符');		}	}    if ($newpassword == '' || strlen($newpassword) < 8) {		redirect('密码不能为空并且密码长度不能小于8位');	}    if ($newpassword != $comfirpassword) {        redirect('请确认输入的密码一致');    }	if (strpos($newpassword,"\n") !== false || strpos($password,"\r") !== false || strpos($password,"\t") !== false) {		redirect('密码包含不可接受字符.');	}	$url = char_cv($url);	if ($url) {		if (isemail($url)) {			$r = $DB->fetch_one_array("SELECT userid FROM {$db_prefix}users WHERE url='$url'");			if($r['userid']) {				redirect('该E-mail已被注册');			}			unset($r);		} else {						if (!preg_match("#^(http|news|https|ftp|ed2k|rtsp|mms)://#", $url)) {				redirect('网站URL错误');			}			$key = array("\\",' ',"'",'"','*',',','<','>',"\r","\t","\n",'(',')','+',';');			foreach($key as $value){				if (strpos($url,$value) !== false){ 					redirect('网站URL错误');				}			}		}	}	$username    = char_cv($username);	$newpassword = md5($newpassword);    $query = $DB->query("SELECT userid FROM {$db_prefix}users WHERE username='$username'");    if($DB->num_rows($query)) {		redirect('该用户名已被注册');    }	$DB->query("INSERT INTO {$db_prefix}users (username, password, url, regdateline, regip, groupid) VALUES ('$username', '$newpassword', '$url', '$timestamp', '$onlineip', '$groupid')");    redirect('添加新用户成功', 'admincp.php?job=user&action=list');}// 修改用户if($action == 'moduser') {		$username       = trim($_POST['username']);	$newpassword    = trim($_POST['newpassword']);	$comfirpassword = trim($_POST['comfirpassword']);	$url            = trim($_POST['url']);	$groupid        = intval($_POST['groupid']);	$userid         = intval($_POST['userid']);	if (!$username || strlen($username) > 20) {		redirect('登陆名不能为空并且不能超过20个字符');    }	$password_sql = '';	if ($newpassword) {		if(strlen($newpassword) < 8) {			redirect('新密码长度不能小于8位');		}		if ($newpassword != $comfirpassword) {			redirect('请确认输入的新密码一致');		}		if (strpos($newpassword,"\n") !== false || strpos($password,"\r") !== false || strpos($password,"\t") !== false) {			redirect('密码包含不可接受字符');		}		$password_sql = ", password='".md5($newpassword)."'";	}	$name_key = array("\\",'&',' ',"'",'"','/','*',',','<','>',"\r","\t","\n",'#','$','(',')','%','@','+','?',';','^');	foreach($name_key as $value){		if (strpos($username,$value) !== false){			redirect('用户名包含敏感字符');		}	}	$url = char_cv($url);	if ($url) {		if (isemail($url)) {			$r = $DB->fetch_one_array("SELECT userid FROM {$db_prefix}users WHERE url='$url' AND userid!='$userid'");			if($r['userid']) {				redirect('该E-mail已被注册');			}			unset($r);		} else {						if (!preg_match("#^(http|news|https|ftp|ed2k|rtsp|mms)://#", $url)) {				redirect('网站URL错误');			}			$key = array("\\",' ',"'",'"','*',',','<','>',"\r","\t","\n",'(',')','+',';');			foreach($key as $value){				if (strpos($url,$value) !== false){ 					redirect('网站URL错误');				}			}		}	}	$username = char_cv($username);    $r = $DB->fetch_one_array("SELECT userid FROM {$db_prefix}users WHERE username='$username' AND userid!='$userid'");    if($r) {		redirect('该用户名已被注册');    }	$usernamesql = $username ? "username='$username'," : '';    $DB->unbuffered_query("UPDATE {$db_prefix}users SET $usernamesql url='$url', groupid='$groupid' $password_sql WHERE userid='$userid'");    redirect('用户修改成功','admincp.php?job=user');}// 删除用户if($action == 'delusers') {	if ($uids = implode_ids($_POST['user'])) {		$aids = 0;		// 删除该用户发表的文章以及相关数据		require_once(TXP_ROOT.'include/attachment.php');		$query = $DB->query("SELECT articleid,visible,cid FROM {$db_prefix}articles WHERE uid IN ($uids)");		while ($article = $DB->fetch_array($query)) {			if ($article['visible']) {				$DB->unbuffered_query("UPDATE {$db_prefix}categories SET articles=articles-1 WHERE cid='".$article['cid']."'");			}			$aids .= ','.$article['articleid'];		}				// 删除该用户的文章中的附件		$query  = $DB->query("SELECT attachmentid,filepath,thumb_filepath FROM {$db_prefix}attachments WHERE articleid IN ($aids)");		$nokeep = array();		while($attach = $DB->fetch_array($query)) {			$nokeep[$attach['attachmentid']] = $attach;		}		removeattachment($nokeep);				$DB->unbuffered_query("DELETE FROM {$db_prefix}comments WHERE articleid IN ($aids)");		$DB->unbuffered_query("DELETE FROM {$db_prefix}articles WHERE uid IN ($uids)");				// 删除用户		$DB->unbuffered_query("DELETE FROM {$db_prefix}users WHERE userid IN ($uids)");		redirect('删除用户成功', 'admincp.php?job=user&action=list');	} else {				redirect('未选择任何用户');	}}if($action == 'list') {	$groupid = intval($_GET['groupid']);	if($page) {		$start_limit = ($page - 1) * 30;	} else {		$start_limit = 0;		$page = 1;	}		$tatol = $DB->num_rows($DB->query("SELECT userid FROM {$db_prefix}users ".$sqladd));	$multipage = multi($tatol, 30, $page, 'admincp.php?job=user&action=list'.$pagelink);	$query = $DB->query("SELECT userid,username,logincount,loginip,logintime,url,regdateline,groupid,lastpost FROM {$db_prefix}users LIMIT $start_limit, 30");	$userdb = array();	while ($user = $DB->fetch_array($query)) {		$user['lastpost']    = $user['lastpost'] ? sadate('Y-m-d H:i',$user['lastpost']) : '从未发表';		$user['regdateline'] = sadate('Y-m-d',$user['regdateline']);		$user['url']         = $user['url'] ? (isemail($user['url']) ? '<a href="mailto:'.$user['url'].'" target="_blank">发送邮件</a>' : '<a href="'.$user['url'].'" target="_blank">访问主页</a>') : '<font color="#FF0000">Null</font>';		$user['logintime'] = $user['logintime'] ? sadate('Y-m-d H:i',$user['logintime']) : '从未登陆';		$user['loginip']   = $user['loginip'] ? $user['loginip'] : '从未登陆';		$user['group'] = $groupdb[$user['groupid']];		$user['disabled'] = ($user['groupid'] == 1 || $user['userid'] == 1) ? 'disabled' : '';		$userdb[] = $user;	}	unset($user);	$DB->free_result($query);}if ($action == 'mod' ) {	$userid = intval($_GET['userid']);	$info = $DB->fetch_one_array("SELECT * FROM {$db_prefix}users WHERE userid='$userid'");	$groupselect[$info['groupid']] = 'selected';}cpheader();include PrintEot('user');?>